
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Metropolitana FM - Diretor</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        @keyframes pulse-border {
            0% { border-color: rgba(250, 204, 21, 0.4); }
            50% { border-color: rgba(250, 204, 21, 1); }
            100% { border-color: rgba(250, 204, 21, 0.4); }
        }
        .now-playing-border { animation: pulse-border 2s infinite; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "jspdf": "https://esm.sh/jspdf@^4.0.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { 
            Search, Calendar, Clock, RefreshCw, Radio, 
            FileText, Music, Loader2, AlertCircle, Activity, Plus 
        } = lucide;

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/1xFRBBHpmn38TiBdZcwn2556811FKkfbeEB3HmmdxT1s/export?format=csv';

        // --- SERVIÇO DE CAPAS ---
        const ARTWORK_CACHE = new Map();
        const fetchArtwork = async (artist, track) => {
            const query = `${artist} ${track}`.toLowerCase().trim();
            if (ARTWORK_CACHE.has(query)) return ARTWORK_CACHE.get(query);
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=1`);
                const data = await res.json();
                const url = data.results?.[0]?.artworkUrl100 || null;
                ARTWORK_CACHE.set(query, url);
                return url;
            } catch { return null; }
        };

        // --- COMPONENTE: CARD ---
        const MusicCard = ({ track, isNowPlaying }) => {
            const [artwork, setArtwork] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchArtwork(track.artista, track.musica).then(url => {
                    setArtwork(url);
                    setLoading(false);
                });
            }, [track.artista, track.musica]);

            const baseClasses = isNowPlaying 
                ? "bg-slate-900 rounded-[2.5rem] border-4 border-yellow-400 shadow-2xl scale-[1.02] z-10 p-6 sm:p-8 now-playing-border" 
                : "bg-white rounded-[2rem] border border-slate-100 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 p-5 sm:p-6";

            return (
                <div className={`flex items-center gap-6 ${baseClasses}`}>
                    <div className={`relative flex-shrink-0 overflow-hidden rounded-2xl bg-slate-100 shadow-inner ${isNowPlaying ? 'w-24 h-24 sm:w-36 sm:h-36' : 'w-20 h-20 sm:w-28 sm:h-28'}`}>
                        {loading ? (
                            <div className="w-full h-full animate-pulse bg-slate-200" />
                        ) : artwork ? (
                            <img src={artwork} alt="Capa" className="w-full h-full object-cover" />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-slate-300">
                                <i data-lucide="music" style={{ width: isNowPlaying ? 48 : 32, height: isNowPlaying ? 48 : 32 }}></i>
                            </div>
                        )}
                    </div>

                    <div className="flex-grow min-w-0">
                        <h3 className={`font-black uppercase truncate leading-tight ${isNowPlaying ? 'text-white text-xl sm:text-2xl' : 'text-slate-800 text-lg sm:text-xl'}`}>
                            {track.musica}
                        </h3>
                        <p className={`font-bold uppercase truncate ${isNowPlaying ? 'text-yellow-400 text-sm sm:text-base' : 'text-sky-500 text-sm sm:text-base'}`}>
                            {track.artista}
                        </p>
                        <div className="mt-3 flex items-center gap-3">
                            <div className={`flex items-center gap-1.5 px-3 py-1 rounded-full ${isNowPlaying ? 'bg-white/10 text-white/60' : 'bg-slate-50 text-slate-500'}`}>
                                <i data-lucide="clock" style={{ width: 14, height: 14 }}></i>
                                <span className="font-bold tabular-nums text-xs sm:text-sm">{track.hora}</span>
                            </div>
                            <span className={`text-[10px] font-black uppercase tracking-widest ${isNowPlaying ? 'text-white/30' : 'text-slate-300'}`}>
                                {track.data}
                            </span>
                        </div>
                    </div>

                    {isNowPlaying && (
                        <div className="hidden lg:block">
                            <div className="bg-red-500 text-white px-4 py-2 rounded-full animate-pulse flex items-center gap-2">
                                <i data-lucide="activity" style={{ width: 14, height: 14 }}></i>
                                <span className="text-[10px] font-black uppercase tracking-tighter">AO VIVO</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ date: '', hour: '', search: '' });
            const [visibleCount, setVisibleCount] = useState(15);

            // Re-renderiza ícones do Lucide sempre que a lista mudar
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const fetchData = useCallback(async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${CSV_URL}&t=${Date.now()}`);
                    const text = await res.text();
                    
                    // Limpa caracteres invisíveis de BOM do CSV
                    const cleanText = text.replace(/^\uFEFF/, '');
                    const lines = cleanText.split('\n').filter(l => l.trim());
                    
                    const rows = lines.map(line => {
                        const cells = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        return cells.map(c => c.replace(/^"|"$/g, '').trim());
                    });

                    if (rows.length < 2) return;

                    // MAPEAMENTO ROBUSTO DE COLUNAS
                    const header = rows[0].map(h => 
                        h.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim()
                    );

                    const findIdx = (keywords) => header.findIndex(h => keywords.some(k => h === k));
                    
                    const idxData = findIdx(['data', 'dia', 'date']);
                    const idxHora = findIdx(['hora', 'time', 'horario', 'momento']);
                    const idxArtista = findIdx(['artista', 'artist', 'autor']);
                    const idxMusica = findIdx(['musica', 'track', 'titulo', 'nome']);

                    const parsed = rows.slice(1).map((row, i) => ({
                        id: `track-${i}`,
                        data: row[idxData] || '---',
                        hora: (row[idxHora] || '').substring(0, 5),
                        artista: row[idxArtista] || 'Desconhecido',
                        musica: row[idxMusica] || 'Sem Título'
                    }))
                    .filter(t => t.artista !== 'Desconhecido' && t.data !== '---' && t.musica !== 'Sem Título')
                    .sort((a, b) => {
                        const [dA, mA, yA] = a.data.split('/');
                        const [dB, mB, yB] = b.data.split('/');
                        const dateA = `${yA}${mA}${dA} ${a.hora}`;
                        const dateB = `${yB}${mB}${dB} ${b.hora}`;
                        return dateB.localeCompare(dateA);
                    });

                    setData(parsed);
                    
                    if (parsed.length > 0 && !filters.date) {
                        setFilters(f => ({ ...f, date: parsed[0].data }));
                    }
                } catch (e) {
                    console.error("Erro CSV:", e);
                } finally {
                    setLoading(false);
                }
            }, [filters.date]);

            useEffect(() => { fetchData(); }, [fetchData]);

            const filteredData = useMemo(() => {
                return data.filter(t => {
                    const mDate = filters.date ? t.data === filters.date : true;
                    const mHour = filters.hour ? t.hora.startsWith(filters.hour) : true;
                    const mSearch = filters.search ? 
                        (`${t.artista} ${t.musica}`).toLowerCase().includes(filters.search.toLowerCase()) : true;
                    return mDate && mHour && mSearch;
                });
            }, [data, filters]);

            const exportPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const now = new Date().toLocaleDateString('pt-BR');
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("METROPOLITANA FM - RELATÓRIO DE PLAYLIST", 14, 20);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Gerado em: ${now} | Filtro: ${filters.date || 'Geral'}`, 14, 28);
                
                let y = 45;
                doc.setFillColor(15, 23, 42);
                doc.rect(14, y - 5, 182, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text("DATA", 16, y);
                doc.text("HORA", 45, y);
                doc.text("ARTISTA", 75, y);
                doc.text("MÚSICA", 135, y);

                doc.setTextColor(30, 41, 59);
                filteredData.forEach(t => {
                    y += 8;
                    if (y > 280) { doc.addPage(); y = 20; }
                    doc.text(t.data, 16, y);
                    doc.text(t.hora, 45, y);
                    doc.text(t.artista.substring(0, 30), 75, y);
                    doc.text(t.musica.substring(0, 30), 135, y);
                });
                
                const suffix = filters.date ? filters.date.replace(/\//g, '-') : 'Geral';
                doc.save(`Playlist_${suffix}.pdf`);
            };

            const uniqueDates = Array.from(new Set(data.map(d => d.data))).sort((a, b) => {
                const [dA, mA, yA] = a.split('/');
                const [dB, mB, yB] = b.split('/');
                return `${yB}${mB}${dB}`.localeCompare(`${yA}${mA}${dA}`);
            });

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto px-6 h-24 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="bg-yellow-400 p-3 rounded-2xl shadow-xl shadow-yellow-100">
                                    <i data-lucide="radio" className="text-white" style={{ width: 28, height: 28 }}></i>
                                </div>
                                <div>
                                    <h1 className="font-black text-2xl tracking-tighter text-slate-900 leading-none">
                                        METROPOLITANA <span className="text-sky-500">FM</span>
                                    </h1>
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Dashboard Diretor</p>
                                </div>
                            </div>
                            <button onClick={fetchData} className="w-12 h-12 flex items-center justify-center bg-slate-50 hover:bg-slate-100 rounded-2xl text-slate-400 transition-all hover:text-sky-500">
                                <i data-lucide="refresh-cw" className={loading ? 'animate-spin' : ''} style={{ width: 22, height: 22 }}></i>
                            </button>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-6 mt-10">
                        <section className="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 mb-12 border border-white">
                            <div className="relative mb-5">
                                <i data-lucide="search" className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300" style={{ width: 24, height: 24 }}></i>
                                <input 
                                    type="text" 
                                    placeholder="Pesquisar por artista ou música..." 
                                    className="w-full pl-16 pr-6 py-5 bg-slate-50 rounded-2xl border-none font-bold text-slate-700 text-lg outline-none focus:ring-4 focus:ring-sky-50 transition-all"
                                    value={filters.search}
                                    onChange={e => setFilters(f => ({ ...f, search: e.target.value }))}
                                />
                            </div>
                            
                            <div className="flex flex-col sm:flex-row gap-4 mb-5">
                                <div className="flex-grow relative">
                                    <i data-lucide="calendar" className="absolute left-5 top-1/2 -translate-y-1/2 text-sky-500" style={{ width: 20, height: 20 }}></i>
                                    <select 
                                        className="w-full pl-14 pr-10 py-5 bg-slate-50 rounded-2xl border-none font-bold text-slate-600 appearance-none cursor-pointer outline-none focus:ring-4 focus:ring-sky-50"
                                        value={filters.date}
                                        onChange={e => setFilters(f => ({ ...f, date: e.target.value }))}
                                    >
                                        <option value="">Todas as Datas</option>
                                        {uniqueDates.map(d => <option key={d} value={d}>{d}</option>)}
                                    </select>
                                </div>
                                <div className="w-full sm:w-44 relative">
                                    <i data-lucide="clock" className="absolute left-5 top-1/2 -translate-y-1/2 text-sky-500" style={{ width: 20, height: 20 }}></i>
                                    <select 
                                        className="w-full pl-14 pr-10 py-5 bg-slate-50 rounded-2xl border-none font-bold text-slate-600 appearance-none cursor-pointer outline-none focus:ring-4 focus:ring-sky-50"
                                        value={filters.hour}
                                        onChange={e => setFilters(f => ({ ...f, hour: e.target.value }))}
                                    >
                                        <option value="">Hora</option>
                                        {Array.from({length: 24}).map((_, i) => {
                                            const h = i.toString().padStart(2, '0');
                                            return <option key={h} value={h}>{h}:00</option>
                                        })}
                                    </select>
                                </div>
                            </div>

                            <button onClick={exportPDF} className="w-full py-5 bg-yellow-400 hover:bg-yellow-500 text-white rounded-2xl font-black uppercase tracking-widest flex items-center justify-center gap-3 transition-all shadow-lg shadow-yellow-100 active:scale-95">
                                <i data-lucide="file-text" style={{ width: 22, height: 22 }}></i> Exportar Playlist PDF
                            </button>
                        </section>

                        <div className="flex flex-col gap-6">
                            {loading ? (
                                <div className="py-24 text-center">
                                    <i data-lucide="loader-2" className="animate-spin mx-auto text-sky-400 mb-4" style={{ width: 48, height: 48 }}></i>
                                    <p className="font-bold text-slate-400 uppercase tracking-widest text-xs">Atualizando Playlist...</p>
                                </div>
                            ) : filteredData.length > 0 ? (
                                <>
                                    {filteredData.slice(0, visibleCount).map((t, idx) => (
                                        <MusicCard 
                                            key={t.id} 
                                            track={t} 
                                            isNowPlaying={idx === 0 && !filters.search && !filters.hour} 
                                        />
                                    ))}
                                    {filteredData.length > visibleCount && (
                                        <button 
                                            onClick={() => setVisibleCount(c => c + 15)}
                                            className="mt-4 py-6 bg-white rounded-[2rem] border-2 border-dashed border-slate-200 text-slate-400 font-bold hover:border-sky-300 hover:text-sky-500 transition-all flex items-center justify-center gap-2"
                                        >
                                            <i data-lucide="plus" style={{ width: 20, height: 20 }}></i> CARREGAR MAIS REGISTROS
                                        </button>
                                    )}
                                </>
                            ) : (
                                <div className="bg-white p-20 rounded-[3rem] text-center border-4 border-dashed border-slate-100">
                                    <i data-lucide="alert-circle" className="mx-auto text-slate-200 mb-4" style={{ width: 64, height: 64 }}></i>
                                    <p className="font-black text-slate-400 uppercase text-sm tracking-widest">Nenhum registro encontrado</p>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
